<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.251">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Lucas Data Explorer</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="lucas_modelling_files/libs/clipboard/clipboard.min.js"></script>
<script src="lucas_modelling_files/libs/quarto-html/quarto.js"></script>
<script src="lucas_modelling_files/libs/quarto-html/popper.min.js"></script>
<script src="lucas_modelling_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="lucas_modelling_files/libs/quarto-html/anchor.min.js"></script>
<link href="lucas_modelling_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="lucas_modelling_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="lucas_modelling_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="lucas_modelling_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="lucas_modelling_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Lucas Data Explorer</h1>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<section id="lucas-data-spatial-distribution" class="level2">
<h2 class="anchored" data-anchor-id="lucas-data-spatial-distribution">LUCAS Data Spatial Distribution</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching packages ─────────────────────────────────────── tidyverse 1.3.1 ──</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ ggplot2 3.3.6     ✔ purrr   0.3.4
✔ tibble  3.1.8     ✔ dplyr   1.0.9
✔ tidyr   1.2.0     ✔ stringr 1.4.1
✔ readr   2.1.2     ✔ forcats 0.5.1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in CPL_gdal_init(): GDAL Error 1: libpodofo.so.0.9.8: cannot open shared
object file: No such file or directory

Warning in CPL_gdal_init(): GDAL Error 1: libpodofo.so.0.9.8: cannot open shared
object file: No such file or directory</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in CPL_gdal_init(): GDAL Error 1: libarrow.so.900: cannot open shared
object file: No such file or directory

Warning in CPL_gdal_init(): GDAL Error 1: libarrow.so.900: cannot open shared
object file: No such file or directory</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in CPL_gdal_init(): GDAL Error 1: libOpenEXR-3_1.so.30: cannot open
shared object file: No such file or directory

Warning in CPL_gdal_init(): GDAL Error 1: libOpenEXR-3_1.so.30: cannot open
shared object file: No such file or directory</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in CPL_gdal_init(): GDAL Error 1: libarrow.so.900: cannot open shared
object file: No such file or directory

Warning in CPL_gdal_init(): GDAL Error 1: libarrow.so.900: cannot open shared
object file: No such file or directory</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in CPL_gdal_init(): GDAL Error 1: libpodofo.so.0.9.8: cannot open shared
object file: No such file or directory

Warning in CPL_gdal_init(): GDAL Error 1: libpodofo.so.0.9.8: cannot open shared
object file: No such file or directory</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in CPL_gdal_init(): GDAL Error 1: libarrow.so.900: cannot open shared
object file: No such file or directory

Warning in CPL_gdal_init(): GDAL Error 1: libarrow.so.900: cannot open shared
object file: No such file or directory</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in CPL_gdal_init(): GDAL Error 1: libOpenEXR-3_1.so.30: cannot open
shared object file: No such file or directory

Warning in CPL_gdal_init(): GDAL Error 1: libOpenEXR-3_1.so.30: cannot open
shared object file: No such file or directory</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in CPL_gdal_init(): GDAL Error 1: libarrow.so.900: cannot open shared
object file: No such file or directory

Warning in CPL_gdal_init(): GDAL Error 1: libarrow.so.900: cannot open shared
object file: No such file or directory</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Linking to GEOS 3.11.0, GDAL 3.5.1, PROJ 9.0.1; sf_use_s2() is TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rnaturalearth)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stars)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: abind</code></pre>
</div>
</div>
</section>
<section id="join-lucas-data-with-spatial-information" class="level1">
<h1>Join Lucas data with spatial information</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>lucas <span class="ot">=</span> <span class="fu">read.csv</span>(<span class="st">"../data/results/lucas_gee_final1.csv"</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>lucas_spatial <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"../data/raw/lucas_2018_checked_v1_2021-12-14.gpkg"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>lucas <span class="ot">=</span> lucas <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="fu">all_of</span>(<span class="fu">c</span>(<span class="st">"point_id"</span>,  <span class="st">"survey_date"</span>, <span class="st">"lc1"</span>, <span class="st">"B2"</span>, <span class="st">"B3"</span>, <span class="st">"B4"</span>, <span class="st">"B8"</span>, <span class="st">"SCL"</span>, <span class="st">"correct_photos"</span>)))</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>lucas <span class="ot">=</span> lucas_spatial <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="fu">all_of</span>(<span class="fu">c</span>(<span class="st">"point_id"</span>, <span class="st">"geom"</span>))) <span class="sc">|&gt;</span>  <span class="fu">right_join</span>(lucas, <span class="at">by =</span> <span class="st">"point_id"</span>)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(lucas)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 6 features and 9 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 6.233115 ymin: 48.61259 xmax: 6.324431 ymax: 49.81601
Geodetic CRS:  WGS 84
  point_id survey_date lc1    B2    B3    B4    B8 SCL correct_photos
1 40502840  2018-05-17 B11   256   473   321  3262   4              1
2 40502862  2018-05-17 B11   215   489   221  4450   4              0
3 40502878  2018-05-22 B11  1650  1960  1556  5468   8              1
4 40502894  2018-06-16 B15  3182  3410  3426  4880   9              2
5 40502908  2018-06-26 B16   261   540   331  4006   4              4
6 40502974  2018-08-22 B16 11416 11104 10960 10911   9              3
                       geom
1 POINT (6.324431 48.61259)
2 POINT (6.309646 48.81026)
3  POINT (6.29909 48.95394)
4 POINT (6.288311 49.09763)
5 POINT (6.278794 49.22336)
6 POINT (6.233115 49.81601)</code></pre>
</div>
</div>
<p>Have a look at the crop types by country.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>sf<span class="sc">::</span><span class="fu">sf_use_s2</span>(<span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Spherical geometry (s2) switched off</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>europe <span class="ot">=</span> rnaturalearth<span class="sc">::</span><span class="fu">ne_countries</span>(<span class="at">returnclass =</span> <span class="st">"sf"</span>,<span class="at">continent =</span> <span class="st">"Europe"</span>) <span class="sc">|&gt;</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="fu">st_crs</span>(lucas)) <span class="sc">|&gt;</span> </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="st">"name"</span>) <span class="sc">|&gt;</span> <span class="fu">rename</span>(<span class="at">country =</span> <span class="st">"name"</span>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>lucas <span class="ot">=</span> <span class="fu">st_join</span>(lucas, europe)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>although coordinates are longitude/latitude, st_intersects assumes that they are planar</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>although coordinates are longitude/latitude, st_intersects assumes that they are planar</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(lucas<span class="sc">$</span>country, lucas<span class="sc">$</span>lc1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                
                  B11  B13  B14  B15  B16  B18  B21  B22  B32  B41  B51  B55
  Austria         236  162   51   23  372   46   29   26   48   15   22   58
  Belarus           6    2   11   12    5    1    0    0    5    1    0    0
  Belgium         190   40    0    4  214    2  108   87   17    4    1  107
  Bulgaria        835   57    9    8  335    2    3    1  109   52    0    2
  Croatia          50    1    3    4  185    2   10    6    7    5   11   23
  Czech Rep.      740  264   25   45  256    7   17   59  396   25   67   11
  Denmark         196  487   53   42  119    1   40    7   90   17   10  110
  Estonia         136  117   10   33    4    0    5    0   46   29   15   20
  Finland         170  423   32  259    0    0   16   12   61   31   26  393
  France         3446  983   79   90 2072  126  174  436 1210  181   86  829
  Germany        2101 1103  524  100 2330  252  254  364 1093  108   67  301
  Greece          103   96    0   43  123    5    9    0   10   25   63    1
  Hungary         392   72   36    9  500   13    5    5  152   10    5   11
  Ireland          39  118    0    9   12    0    7    3    4    6    2   26
  Italy           552  295    6  127  814   22   28   21   13  211   75  387
  Latvia          459  120   20   65   41   13   13    1  146   59   10   49
  Lithuania       352  121   21   87   21   37   10    9  129  105   13   34
  Luxembourg       15    8    1    2   19    2    1    0    3    0    2   11
  Moldova          11    0    0    0   11    0    0    1   10    0    0    3
  Netherlands     120   26    6    4  274    2  222  101    2    4    6   85
  Poland         1648  733  943  514 1043  524  156  171  782  152   27   68
  Portugal         27   15   14   71  104    6   21    0    2    3    0   94
  Romania         811   80   29   28 1174    7   40   26  302   23   21  140
  Russia            5    2    0    3    1    0    0    0    4    0    0    0
  Serbia            1    1    0    1    1    0    0    0    1    1    0    0
  Slovakia        147   67    7    4  112    3    6    7   83    9   11    7
  Slovenia         38    7    0    1   83    5    0    1    5    2    1   28
  Spain          1318 2067  142  441  433   69   82   29   69  321    4  273
  Sweden          404  319   37  132   10    1   27   37  108   42   34  325
  Switzerland       2    0    0    0   10    1    0    0    2    0    2    0
  Ukraine          14    6    1    0    3    2    1    3    7    0    0    0
  United Kingdom  768  518    7   60  109    0   79   86  235   74    5  425</code></pre>
</div>
</div>
</section>
<section id="filter-subset" class="level1">
<h1>Filter Subset</h1>
<p>For demo purposes, I filter a subset of some countries. One for training the model, the other one to apply the model to.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>lucas_train <span class="ot">=</span> lucas <span class="sc">|&gt;</span> <span class="fu">filter</span>(country <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Belgium"</span>, <span class="st">"Netherlands"</span>, <span class="st">"Poland"</span>, <span class="st">"Germany"</span>))</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>lucas_test <span class="ot">=</span> lucas <span class="sc">|&gt;</span> <span class="fu">filter</span>(country <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Spain"</span>, <span class="st">"Italy"</span>, <span class="st">"Portugal"</span>))</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(lucas_train<span class="sc">$</span>lc1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
 B11  B13  B14  B15  B16  B18  B21  B22  B32  B41  B51  B55 
4059 1902 1473  622 3861  780  740  723 1894  268  101  561 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(lucas_test<span class="sc">$</span>lc1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
 B11  B13  B14  B15  B16  B18  B21  B22  B32  B41  B51  B55 
1897 2377  162  639 1351   97  131   50   84  535   79  754 </code></pre>
</div>
</div>
</section>
<section id="training-a-random-forest-model-with-cross-validation" class="level1">
<h1>Training a random forest model with cross validation</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: lattice</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'caret'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:purrr':

    lift</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ranger)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(CAST)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>lucas_train <span class="ot">=</span> lucas_train <span class="sc">|&gt;</span> <span class="fu">st_drop_geometry</span>()</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="co"># create cv folds based on country</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>folds <span class="ot">=</span> CAST<span class="sc">::</span><span class="fu">CreateSpacetimeFolds</span>(<span class="at">x =</span> lucas_train, <span class="at">spacevar =</span> <span class="st">"country"</span>, <span class="at">k =</span> <span class="dv">4</span>, <span class="at">class =</span> <span class="st">"lc1"</span>, <span class="at">seed =</span> <span class="dv">1</span>)</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a><span class="co"># train control to specify additonal model parameters (cv method)</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>trc <span class="ot">=</span> <span class="fu">trainControl</span>(<span class="at">method =</span> <span class="st">"cv"</span>, <span class="at">index =</span> folds<span class="sc">$</span>index, <span class="at">indexOut =</span> folds<span class="sc">$</span>indexOut, <span class="at">number =</span> <span class="dv">4</span>, <span class="at">savePredictions =</span> <span class="cn">TRUE</span>)</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a><span class="co"># train the model:</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a><span class="co">#- random forest from the "ranger" package</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a><span class="co">#- tuneLength = 1: no hyperparameter tuning</span></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a><span class="co">#- num.trees: 50 trees in the rf model</span></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a><span class="co">#- importance: variable importance calculation</span></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>rfmodel <span class="ot">=</span> caret<span class="sc">::</span><span class="fu">train</span>(<span class="at">x =</span> lucas_train <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="fu">all_of</span>(<span class="fu">c</span>(<span class="st">"B2"</span>, <span class="st">"B3"</span>, <span class="st">"B4"</span>, <span class="st">"B8"</span>))),</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>                       <span class="at">y =</span> lucas_train <span class="sc">|&gt;</span> <span class="fu">pull</span>(<span class="st">"lc1"</span>),</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>                       <span class="at">method =</span> <span class="st">"ranger"</span>,</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>                       <span class="at">tuneLength =</span> <span class="dv">1</span>,</span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>                       <span class="at">trControl =</span> trc,</span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>                       <span class="at">num.trees =</span> <span class="dv">50</span>,</span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>                       <span class="at">importance =</span> <span class="st">"impurity"</span>)</span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>rfmodel</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Random Forest 

16984 samples
    4 predictor
   12 classes: 'B11', 'B13', 'B14', 'B15', 'B16', 'B18', 'B21', 'B22', 'B32', 'B41', 'B51', 'B55' 

No pre-processing
Resampling: Cross-Validated (4 fold) 
Summary of sample sizes: 13602, 11789, 13889, 11672 
Resampling results across tuning parameters:

  splitrule   Accuracy   Kappa     
  gini        0.1269416  0.01580005
  extratrees  0.1260321  0.01497714

Tuning parameter 'mtry' was held constant at a value of 2
Tuning
 parameter 'min.node.size' was held constant at a value of 1
Accuracy was used to select the optimal model using the largest value.
The final values used for the model were mtry = 2, splitrule = gini
 and min.node.size = 1.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># accuracy assessment over all cv folds</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>CAST<span class="sc">::</span><span class="fu">global_validation</span>(rfmodel)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      Accuracy          Kappa  AccuracyLower  AccuracyUpper   AccuracyNull 
    0.13406736    -0.05643357     0.12897662     0.13928375     0.23898964 
AccuracyPValue  McnemarPValue 
    1.00000000            NaN </code></pre>
</div>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># predict on other countries</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>lucas_test<span class="sc">$</span>validation <span class="ot">=</span> <span class="fu">predict</span>(rfmodel, lucas_test <span class="sc">|&gt;</span> <span class="fu">st_drop_geometry</span>())</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="co"># confusion matrix of prediction</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>caret<span class="sc">::</span><span class="fu">confusionMatrix</span>(<span class="fu">as.factor</span>(lucas_test<span class="sc">$</span>lc1), lucas_test<span class="sc">$</span>validation)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Confusion Matrix and Statistics

          Reference
Prediction  B11  B13  B14  B15  B16  B18  B21  B22  B32  B41  B51  B55
       B11  740  182   87   27  606   32   21   25  159    3    0   15
       B13 1012  276   77   28  536   38   28   48  317    3    1   13
       B14   49   15    7    5   47    0    4    4   29    0    1    1
       B15  290   60   25    4  156    9    2   12   68    1    0   12
       B16  442  122   55   17  511   18   26   33  108    5    1   13
       B18   42   14    5    1   22    1    0    1    9    0    0    2
       B21   35   10    3    2   41    1    3    6   23    2    1    4
       B22   11    5    2    0   13    0    5    7    7    0    0    0
       B32   25    7    4    1   27    0    2    5   12    0    0    1
       B41  159   66   24   13  154    9   10   27   65    1    0    7
       B51   22    7    2    1   28    1    5    3    9    0    0    1
       B55  217   75   53   13  221   16   22   37   76    4    6   14

Overall Statistics
                                         
               Accuracy : 0.1932         
                 95% CI : (0.1847, 0.202)
    No Information Rate : 0.3732         
    P-Value [Acc &gt; NIR] : 1              
                                         
                  Kappa : 0.0286         
                                         
 Mcnemar's Test P-Value : NA             

Statistics by Class:

                     Class: B11 Class: B13 Class: B14 Class: B15 Class: B16
Sensitivity             0.24310    0.32896  0.0203488  0.0357143    0.21634
Specificity             0.77367    0.71286  0.9801587  0.9210592    0.85502
Pos Pred Value          0.39009    0.11611  0.0432099  0.0062598    0.37824
Neg Pred Value          0.63189    0.90258  0.9578434  0.9856326    0.72799
Prevalence              0.37322    0.10287  0.0421775  0.0137322    0.28960
Detection Rate          0.09073    0.03384  0.0008583  0.0004904    0.06265
Detection Prevalence    0.23259    0.29144  0.0198627  0.0783472    0.16564
Balanced Accuracy       0.50839    0.52091  0.5002538  0.4783867    0.53568
                     Class: B18 Class: B21 Class: B22 Class: B32 Class: B41
Sensitivity           0.0080000  0.0234375  0.0336538   0.013605  0.0526316
Specificity           0.9880463  0.9840558  0.9945898   0.990102  0.9343738
Pos Pred Value        0.0103093  0.0229008  0.1400000   0.142857  0.0018692
Neg Pred Value        0.9846135  0.9844237  0.9752036   0.892220  0.9976381
Prevalence            0.0153261  0.0156940  0.0255027   0.108141  0.0023296
Detection Rate        0.0001226  0.0003678  0.0008583   0.001471  0.0001226
Detection Prevalence  0.0118931  0.0160618  0.0061305   0.010299  0.0655959
Balanced Accuracy     0.4980232  0.5037467  0.5141218   0.501854  0.4935027
                     Class: B51 Class: B55
Sensitivity            0.000000   0.168675
Specificity            0.990302   0.908336
Pos Pred Value         0.000000   0.018568
Neg Pred Value         0.998762   0.990678
Prevalence             0.001226   0.010177
Detection Rate         0.000000   0.001717
Detection Prevalence   0.009686   0.092447
Balanced Accuracy      0.495151   0.538506</code></pre>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>